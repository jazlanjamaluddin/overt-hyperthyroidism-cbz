<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Anti-thyroid Drug Dose Adjustment Aid</title>
  <style>
    :root{
      --blue:#0672B7;
      --teal:#1DCFD0;
      --cyan:#1199C8;
      --pink:#EF71A5;

      --bg1:#071826;
      --bg2:#0b2a3a;
      --card:#0f2232cc;
      --cardSolid:#0f2232;
      --text:#e9f3ff;
      --muted:#b9d3ea;
      --border:rgba(255,255,255,.12);
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --radius:18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1100px 700px at 15% 15%, rgba(29,207,208,.22), transparent 55%),
        radial-gradient(1000px 700px at 85% 25%, rgba(6,114,183,.22), transparent 58%),
        radial-gradient(900px 650px at 65% 85%, rgba(239,113,165,.18), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }

    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:28px 16px 40px;
    }

    header{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-bottom:18px;
    }

    .titleRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      flex-wrap:wrap;
    }

    h1{
      font-size: clamp(22px, 2.7vw, 34px);
      letter-spacing:.2px;
      margin:0;
      line-height:1.15;
    }

    .brandPill{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:999px;
      background:linear-gradient(135deg, rgba(6,114,183,.14), rgba(29,207,208,.12), rgba(239,113,165,.10));
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      user-select:none;
      white-space:nowrap;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background:var(--cyan);
      box-shadow:0 0 0 6px rgba(17,153,200,.18);
    }
    .brandPill span{
      color:var(--muted);
      font-size:13px;
    }

    .subtitle{
      margin:0;
      color:var(--muted);
      line-height:1.35;
      font-size:14px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px;
      margin-top:14px;
    }
    @media (max-width: 860px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background:linear-gradient(180deg, rgba(15,34,50,.92), rgba(15,34,50,.72));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      position:relative;
      overflow:hidden;
    }

    .card::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(420px 220px at 15% 0%, rgba(29,207,208,.18), transparent 60%),
        radial-gradient(420px 220px at 90% 10%, rgba(6,114,183,.16), transparent 60%),
        radial-gradient(480px 260px at 65% 110%, rgba(239,113,165,.12), transparent 62%);
      pointer-events:none;
      filter:saturate(1.15);
    }

    .card > *{position:relative}

    .card h2{
      margin:0 0 10px 0;
      font-size:16px;
      letter-spacing:.2px;
    }

    .section{
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:12px;
      background:rgba(255,255,255,.03);
      margin-top:10px;
    }

    .sectionTitle{
      margin:0 0 10px 0;
      font-size:13px;
      color:var(--muted);
      letter-spacing:.2px;
    }

    .fields{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .fields.oneCol{grid-template-columns:1fr}
    .fields.three{
      grid-template-columns: 1fr 1fr 1fr;
    }
    @media (max-width: 520px){
      .fields, .fields.three{grid-template-columns:1fr}
    }

    label{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:12px;
      color:var(--muted);
    }

    input{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(7,24,38,.55);
      color:var(--text);
      outline:none;
      transition: border-color .15s ease, box-shadow .15s ease, transform .06s ease;
    }
    input::placeholder{color:rgba(185,211,234,.55)}
    input:focus{
      border-color: rgba(29,207,208,.55);
      box-shadow: 0 0 0 4px rgba(29,207,208,.12);
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:14px;
    }

    button{
      border:0;
      cursor:pointer;
      padding:12px 14px;
      border-radius:14px;
      font-weight:650;
      letter-spacing:.15px;
      transition: transform .06s ease, filter .15s ease, box-shadow .15s ease, background .15s ease;
    }
    button:active{transform: translateY(1px)}
    .primary{
      color:#071826;
      background: linear-gradient(135deg, var(--teal), var(--cyan), var(--blue));
      box-shadow: 0 14px 40px rgba(17,153,200,.20);
      min-width: 170px;
    }
    .primary:hover{filter:brightness(1.06)}
    .secondary{
      color:var(--text);
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
    }
    .secondary:hover{filter:brightness(1.06)}

    .resultCard{
      margin-top:16px;
      background:linear-gradient(180deg, rgba(15,34,50,.92), rgba(15,34,50,.72));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      overflow:hidden;
      position:relative;
    }
    .resultCard::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(520px 260px at 0% 0%, rgba(6,114,183,.20), transparent 60%),
        radial-gradient(520px 260px at 100% 0%, rgba(29,207,208,.18), transparent 62%),
        radial-gradient(640px 320px at 60% 120%, rgba(239,113,165,.14), transparent 65%);
      pointer-events:none;
    }
    .resultCard > *{position:relative}

    .resultHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }

    .badge{
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--muted);
      user-select:none;
    }

    .resultText{
      white-space:pre-wrap;
      font-size:15px;
      line-height:1.45;
      margin:0;
    }

    .note{
      margin-top:12px;
      border-radius:14px;
      padding:12px;
      border:1px solid rgba(239,113,165,.35);
      background: rgba(239,113,165,.09);
      color: rgba(255,255,255,.92);
      font-size:13px;
      line-height:1.35;
    }

    .error{
      margin-top:12px;
      border-radius:14px;
      padding:12px;
      border:1px solid rgba(239,113,165,.40);
      background: rgba(239,113,165,.11);
      color: rgba(255,255,255,.94);
      font-size:13px;
      line-height:1.35;
      display:none;
      white-space:pre-wrap;
    }

    .foot{
      margin-top:14px;
      color:rgba(185,211,234,.65);
      font-size:12px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="titleRow">
        <h1>Anti-thyroid Drug Dose Adjustment Aid</h1>
        <div class="brandPill" aria-hidden="true" title="CBZ dose adjustment aid">
          <span class="dot"></span>
          <span>CBZ decision aid</span>
        </div>
      </div>
      <p class="subtitle">Decision aid to support adjustment of Carbimazole (CBZ) dose in patients with OVERT Hyperthyroidism especially Graves' Disease. Use clinical judgement and local protocols</p>
    </header>

    <div class="grid">
      <div class="card">
        <h2>Normal ranges</h2>

        <div class="section">
          <p class="sectionTitle">FT4 or FT3 normal range</p>
          <div class="fields">
            <label>
              Lower limit (LL)
              <input id="ftLL" type="number" inputmode="decimal" step="any" placeholder="e.g., 10" />
            </label>
            <label>
              Upper limit (UL)
              <input id="ftUL" type="number" inputmode="decimal" step="any" placeholder="e.g., 22" />
            </label>
          </div>
        </div>

        <div class="section">
          <p class="sectionTitle">TSH normal range</p>
          <div class="fields">
            <label>
              Lower limit (LL)
              <input id="tshLL" type="number" inputmode="decimal" step="any" placeholder="e.g., 0.27" />
            </label>
            <label>
              Upper limit (UL)
              <input id="tshUL" type="number" inputmode="decimal" step="any" placeholder="optional (enables high vs normal)" />
            </label>
          </div>
        </div>

        <div class="actions">
          <button class="primary" id="btnSuggest" type="button">Get suggestion</button>
          <button class="secondary" id="btnReset" type="button">Reset</button>
        </div>

        <div class="error" id="errorBox" role="alert" aria-live="polite"></div>
      </div>

      <div class="card">
        <h2>Patient values</h2>

        <div class="section">
          <p class="sectionTitle">Current treatment</p>
          <div class="fields">
            <label>
              Duration on ATD (months)
              <input id="duration" type="number" inputmode="decimal" step="any" placeholder="e.g., 0, 2, 6" />
            </label>
            <label>
              Current CBZ dose (mg/day)
              <input id="dose" type="number" inputmode="decimal" step="any" placeholder="e.g., 10" />
            </label>
          </div>
        </div>

        <div class="section">
          <p class="sectionTitle">Current TFT result</p>
          <div class="fields">
            <label>
              FT4 or FT3 result
              <input id="ftValue" type="number" inputmode="decimal" step="any" placeholder="numeric value" />
            </label>
            <label>
              TSH result
              <input id="tshValue" type="number" inputmode="decimal" step="any" placeholder="numeric value" />
            </label>
          </div>
        </div>

        <div class="note">
          <strong>Safety notes:</strong> This tool does not check contraindications, pregnancy, severe symptoms/thyroid storm, agranulocytosis risk, liver disease, drug interactions, or adherence barriers.
        </div>

        <p class="foot">Tip: If TSH UL is left blank, the tool can only detect “suppressed” (TSH &lt; LL) vs “not suppressed”.</p>
      </div>
    </div>

    <div class="resultCard" aria-live="polite">
      <div class="resultHeader">
        <h2 style="margin:0;font-size:16px;">Recommendation</h2>
        <span class="badge">Shows final recommendation only</span>
      </div>
      <p class="resultText" id="resultText">Enter values, then click “Get suggestion”.</p>
    </div>
  </div>

  <script>
    "use strict";

    // Helper functions (required)
    function inRange(value, min, max){
      return value >= min && value <= max;
    }

    function classify(value, LL, UL){
      // Returns: "low", "normal", "high"
      if (value < LL) return "low";
      if (value > UL) return "high";
      return "normal";
    }

    function $(id){ return document.getElementById(id); }

    function parseNum(id){
      var el = $(id);
      var raw = (el.value || "").trim();
      if (raw === "") return { ok:false, value:null };
      var v = Number(raw);
      if (!Number.isFinite(v)) return { ok:false, value:null };
      return { ok:true, value:v };
    }

    function showError(msg){
      var box = $("errorBox");
      if (!msg){
        box.style.display = "none";
        box.textContent = "";
        return;
      }
      box.style.display = "block";
      box.textContent = msg;
    }

    function setResult(text){
      $("resultText").textContent = text;
    }

    function validateAndGetInputs(){
      var ftLL = parseNum("ftLL");
      var ftUL = parseNum("ftUL");
      var tshLL = parseNum("tshLL");
      var tshUL = parseNum("tshUL"); // optional
      var duration = parseNum("duration");
      var dose = parseNum("dose");
      var ftValue = parseNum("ftValue");
      var tshValue = parseNum("tshValue");

      var missing = [];
      if (!ftLL.ok) missing.push("FT4/FT3 LL");
      if (!ftUL.ok) missing.push("FT4/FT3 UL");
      if (!tshLL.ok) missing.push("TSH LL");
      if (!duration.ok) missing.push("Duration on ATD (months)");
      if (!dose.ok) missing.push("Current CBZ dose (mg/day)");
      if (!ftValue.ok) missing.push("FT4/FT3 result");
      if (!tshValue.ok) missing.push("TSH result");

      if (missing.length){
        return { ok:false, error: "Please enter the following required value(s):\n- " + missing.join("\n- ") };
      }

      if (ftUL.value <= ftLL.value){
        return { ok:false, error: "FT4/FT3 range is invalid. UL must be greater than LL." };
      }

      if (tshUL.ok && tshUL.value <= tshLL.value){
        return { ok:false, error: "TSH range is invalid. UL must be greater than LL (or leave UL blank)." };
      }

      if (duration.value < 0){
        return { ok:false, error: "Duration on ATD (months) cannot be negative." };
      }

      if (dose.value < 0){
        return { ok:false, error: "Current CBZ dose (mg/day) cannot be negative." };
      }

      return {
        ok:true,
        data:{
          ftLL: ftLL.value,
          ftUL: ftUL.value,
          tshLL: tshLL.value,
          tshUL: tshUL.ok ? tshUL.value : null,
          durationMonths: duration.value,
          doseMg: dose.value,
          ftValue: ftValue.value,
          tshValue: tshValue.value
        }
      };
    }

    function getTSHCategory(tshValue, tshLL, tshUL){
      // If tshUL is null, only detect suppressed (<LL) vs not suppressed.
      if (tshUL === null){
        return (tshValue < tshLL) ? "suppressed" : "notSuppressed";
      }
      var cls = classify(tshValue, tshLL, tshUL);
      if (cls === "low") return "suppressed";
      if (cls === "normal") return "normal";
      return "high";
    }

    function decideRecommendation(d){
      var ftClass = classify(d.ftValue, d.ftLL, d.ftUL); // low/normal/high
      var tshCat = getTSHCategory(d.tshValue, d.tshLL, d.tshUL); // suppressed/normal/high or suppressed/notSuppressed
      var tshHasUL = (d.tshUL !== null);

      // Ratios for start rules
      var ftRatio = d.ftValue / d.ftUL;

      // Rule table (implement exactly in order, first match wins)

      // A) Duration = 0 months (start)
      if (d.durationMonths === 0){
        // 1. If TSH < LL and FT4/FT3 between 1×UL and 1.5×UL
        if (d.tshValue < d.tshLL && ftRatio >= 1 && ftRatio < 1.5){
          return "Suggest to start CBZ 5–10 mg OD. Repeat TFT after 2–6 weeks.";
        }
        // 2. If TSH < LL and FT4/FT3 between 1.5×UL and 2×UL
        if (d.tshValue < d.tshLL && ftRatio >= 1.5 && ftRatio <= 2){
          return "Suggest to start CBZ 10–20 mg OD. Repeat TFT after 2–6 weeks.";
        }
        // 3. If TSH < LL and FT4/FT3 > 2×UL
        if (d.tshValue < d.tshLL && ftRatio > 2){
          return "Suggest to start CBZ 30–40 mg/day (e.g., 20 mg BD).";
        }
        // 4. If TSH within range and FT4/FT3 within range
        if (tshHasUL && inRange(d.tshValue, d.tshLL, d.tshUL) && ftClass === "normal"){
          return "Normal TFT result. Please do not use this decision aid.";
        }
        // 5. If TSH > UL with any FT4/FT3
        if (tshHasUL && d.tshValue > d.tshUL){
          return "Unlikely overt hyperthyroidism. Please do not use this decision aid.";
        }
        // 6. Else (Other/Other)
        return "Unlikely overt hyperthyroidism. Please do not use this decision aid.";
      }

      // B) Duration 1 to 3 months (any dose)
      if (d.durationMonths >= 1 && d.durationMonths <= 3){
        // 7. If FT4/FT3 normal
        if (ftClass === "normal"){
          return "Decrease ATD dose by 30–50%. Repeat TFT after 4–6 weeks.";
        }
        // 8. If FT4/FT3 > UL
        if (ftClass === "high"){
          return "May continue current dose. Suggest to gradually reduce if FT4 is reducing in trend. Repeat TFT after 2–6 weeks.";
        }
        // 9. If FT4/FT3 < LL
        if (ftClass === "low"){
          return "Consider stopping ATDs temporarily or reducing to CBZ 5–10 mg daily. Repeat TFT after 2 weeks.";
        }
      }

      // C) Duration 3 to 18 months
      if (d.durationMonths > 3 && d.durationMonths <= 18){
        // 10. If FT4/FT3 normal and TSH normal (any dose)
        if (ftClass === "normal" && tshHasUL && tshCat === "normal"){
          return "Taper down ATD until minimal dose. Repeat TFT after 2–3 months.";
        }
        // 11. If FT4/FT3 > UL and dose < 15 mg/day
        if (ftClass === "high" && d.doseMg < 15){
          return "Check adherence. Consider continuing old dose or increasing dose. Repeat TFT after 2–6 weeks.";
        }
        // 12. If FT4/FT3 > UL and dose ≥ 15 mg/day
        if (ftClass === "high" && d.doseMg >= 15){
          return "Suggest to increase dose of ATD. Expert opinion is needed. Consider referral for RAI or surgery.";
        }
        // 13. If FT4/FT3 < LL and dose ≥ 15 mg/day
        if (ftClass === "low" && d.doseMg >= 15){
          return "Consider reduce to minimal dose. Repeat TFT after 2–6 weeks.";
        }
        // 14. If FT4/FT3 < LL and dose ≤ 15 mg/day
        if (ftClass === "low" && d.doseMg <= 15){
          return "Taper down ATD until minimal dose. Repeat TFT after 2–6 weeks.";
        }
      }

      // D) Duration > 18 months
      if (d.durationMonths > 18){
        // 15. If dose ≤ 5 AND FT4/FT3 normal AND TSH normal
        if (d.doseMg <= 5 && ftClass === "normal" && tshHasUL && tshCat === "normal"){
          return "Discontinue ATD. Repeat TFT every 1–3 months for 12 months.";
        }
        // 16. If dose ≤ 5 AND FT4/FT3 normal AND TSH suppressed
        if (d.doseMg <= 5 && ftClass === "normal" && tshCat === "suppressed"){
          return "Taper down ATD until minimal dose. Discuss about RAI or surgery as response may be unlikely.";
        }
        // 17. If dose ≤ 5 AND FT4/FT3 normal AND TSH high
        if (d.doseMg <= 5 && ftClass === "normal" && tshHasUL && tshCat === "high"){
          return "Discontinue ATD. Repeat TFT every 1–3 months for 12 months.";
        }
        // 18. If dose ≤ 5 AND FT4/FT3 high
        if (d.doseMg <= 5 && ftClass === "high"){
          return "Continue current dose of ATD. Discuss about RAI or surgery as response may be unlikely.";
        }
        // 19. If dose ≤ 5 AND FT4/FT3 low
        if (d.doseMg <= 5 && ftClass === "low"){
          return "Discontinue ATD. Repeat TFT every 1–3 months for 12 months.";
        }
        // 20. If dose > 5 AND FT4/FT3 normal (any TSH)
        if (d.doseMg > 5 && ftClass === "normal"){
          return "Taper down ATD until minimal dose. Repeat TFT after 2–6 weeks. If unable to taper to lower dose or discontinue ATD, consider referral for RAI or surgery.";
        }
        // 21. If dose > 5 AND FT4/FT3 high (any TSH)
        if (d.doseMg > 5 && ftClass === "high"){
          return "Consider referral for RAI or surgery.";
        }
        // 22. If dose 5 to 10 AND FT4/FT3 low
        if (d.doseMg >= 5 && d.doseMg <= 10 && ftClass === "low"){
          return "May consider discontinue ATD. Repeat TFT every 1–3 months for 12 months.";
        }
        // 23. If dose > 10 AND FT4/FT3 low
        if (d.doseMg > 10 && ftClass === "low"){
          return "Taper down ATD until minimal dose. Repeat TFT after 2–6 weeks. If still unable to taper to lower dose or discontinue ATD, consider referral for RAI or surgery.";
        }
        // 24. Extra gap coverage: If dose > 5 AND dose < 10 AND FT4/FT3 low
        if (d.doseMg > 5 && d.doseMg < 10 && ftClass === "low"){
          return "May consider discontinue ATD. Repeat TFT every 1–3 months for 12 months.";
        }
      }

      // If nothing matched (should be rare), give a safe nudge without exposing internal details.
      return "No suggestion could be generated with the provided values. Please re-check inputs and use clinical judgement and local protocols.";
    }

    function onSuggest(){
      showError("");
      var v = validateAndGetInputs();
      if (!v.ok){
        showError(v.error);
        setResult("Enter values, then click “Get suggestion”.");
        return;
      }
      var rec = decideRecommendation(v.data);
      // Only show final recommendation text, no rule identifiers.
      setResult(rec);
    }

    function onReset(){
      showError("");
      var ids = ["ftLL","ftUL","tshLL","tshUL","duration","dose","ftValue","tshValue"];
      for (var i=0;i<ids.length;i++){
        $(ids[i]).value = "";
      }
      setResult("Enter values, then click “Get suggestion”.");
      $("ftLL").focus();
    }

    $("btnSuggest").addEventListener("click", onSuggest);
    $("btnReset").addEventListener("click", onReset);

    // Enter key triggers suggestion when focused in inputs
    var allInputs = document.querySelectorAll("input");
    for (var i=0;i<allInputs.length;i++){
      allInputs[i].addEventListener("keydown", function(e){
        if (e.key === "Enter"){
          e.preventDefault();
          onSuggest();
        }
      });
    }
  </script>
</body>
</html>
